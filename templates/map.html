{% extends "base.html" %}

{% block title %}Map{% endblock %}

<!--Hero Section-->
{% block hero_title %}The Map{% endblock %}
{% block hero_p %}Explore OSU and Corvallis with our custom map api{% endblock %}

{% block content %}
<div class="container">
  <!-- Search Ribbon -->
  <div class="search-ribbon">
    <h2>Search</h2>
    <div class="search-bar">
      <input type="text" placeholder="Search locations...">
    </div>

    <!-- Filter by Tag -->
    <div class="filter">
      <form method="GET">
        <label for="tag">Filter by Tag:</label>
        <select id="tag" name="tag">
          <option value="">All</option>
          {% for tag in available_tags %}
            <option value="{{ tag }}" {% if tag == selected_tag %}selected{% endif %}>{{ tag }}</option>
          {% endfor %}
        </select>
        <button type="submit">Apply Filter</button>
      </form>
    </div>

    <div class="top-searched">
      <h3>Top Searched</h3>
      <ul>
        <li>Location 1</li>
        <li>Location 2</li>
        <li>Location 3</li>
        <li>Location 4</li>
        <li>Location 5</li>
      </ul>
    </div>
  </div>

  <!-- Map and Info Section -->
  <div class="map-info-container">
    <div class="map-container" id="map"></div>

    <!-- Info Section -->
    <div class="info-section" id="info-section">
      <h3>Marker Information</h3>
      <p>Select a location on the map or from the search ribbon to view more details.</p>
    </div>
  </div>
</div>

<!-- Leaflet.js Script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<!-- Pass markers to JavaScript as a JSON object -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var markers = {{ markers | tojson }};  // Markers passed from backend
    var selectedTag = "{{ selected_tag }}"; // Get the selected tag from the backend

    var map = L.map('map').setView([44.5646, -123.2620], 14);  // Center the map to Corvallis, OR

    // Set up the OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var infoSection = document.getElementById('info-section');

    // Function to filter markers by tag
    function filterMarkersByTag(tag) {
      if (!tag) {
        return markers;  // Return all markers if no tag is selected
      }
      return markers.filter(function(marker) {
        return marker.tag === tag;  // Only return markers with the selected tag
      });
    }

    // Function to add markers to the map
    function addMarkers(filteredMarkers) {
      // Clear existing markers
      map.eachLayer(function(layer) {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });

      // Loop through the filtered markers and create them
      filteredMarkers.forEach(function(markerData) {
        var marker = L.marker([markerData.lat, markerData.lng]).addTo(map);
        marker.bindPopup("<b>" + markerData.name + "</b>");

        // Event listener for marker click
        marker.on('click', function() {
          infoSection.innerHTML = `
            <h3>${markerData.name}</h3>
            <p>${markerData.description}</p>
          `;
        });
      });
    }

    // Filter and add the markers for the selected tag
    var filteredMarkers = filterMarkersByTag(selectedTag);
    addMarkers(filteredMarkers);
  });
</script>

{% endblock %}
